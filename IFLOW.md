# py-video 项目文档

## 项目概述

**py-video** 是一个基于 Python 的视频处理工具集，主要用于视频内容制作中的自动化处理工作。项目包含两个核心功能：

1. **视频时长调整工具**：根据字幕文件的时间信息，智能调整视频时长到目标值
2. **分镜描述词提取工具**：从结构化文本中提取分镜、图片描述词和视频描述词

## 项目结构

```
py-video/
├── main.py              # 视频时长调整主程序
├── txt_split.py         # 分镜描述词提取工具
├── gui_app.py           # 图形用户界面主程序
├── 分镜描述词助手.bat    # Windows批处理脚本（分镜提取）
├── 视频匀速助手.bat      # Windows批处理脚本（视频调整）
├── 视频处理助手.bat      # Windows批处理脚本（图形界面）
├── .gitignore          # Git忽略文件配置
└── IFLOW.md           # 项目说明文档（本文件）
```

## 核心功能详解

### 1. 视频时长调整工具 (`main.py`)

**功能**：根据字幕文件（.srt）和分镜文件（.txt）计算每个视频片段的理想时长，并调整视频速度以达到目标时长。

**主要特性**：
- 支持 MP4 视频格式
- 智能判断视频时长：过短则减速，过长则加速
- 精确帧率控制，确保输出视频时长准确
- 批量处理文件夹中的所有视频文件

**输入要求**：
- 字幕文件 (.srt)：包含时间轴和文本内容
- 分镜文件 (.txt)：定义视频片段的组合方式
- 视频文件夹：包含需要处理的 MP4 视频文件

**输出**：
- 在视频文件夹下创建 `adjusted_videos` 子文件夹
- 处理后的视频文件保持原文件名

### 2. 分镜描述词提取工具 (`txt_split.py`)

**功能**：从结构化文本中提取三种类型的描述词，用于视频制作流程。

**提取内容**：
1. **分镜** (storyboard)：视频场景描述
2. **图片描述词** (image_description)：静态图片描述
3. **视频描述词** (video_description)：动态视频描述

**输入格式**：
```
1
场景描述1
图片描述1
视频描述1

2
场景描述2
图片描述2
视频描述2
```

**输出文件**：
- `分镜.txt`：包含所有分镜描述
- `图片描述词.txt`：包含所有图片描述词
- `视频描述词.txt`：包含所有视频描述词

## 环境要求

### Python 依赖
```bash
# 核心依赖
moviepy==1.0.3  # 视频处理库

# 可选依赖（通过conda安装）
conda install -c conda-forge moviepy
```

### 系统要求
- Python 3.6+
- FFmpeg（moviepy 依赖，通常会自动安装）
- Windows 系统（批处理脚本为 Windows 设计）

## 使用方法

### 方法一：使用图形界面（推荐）

#### 启动图形界面
1. 双击运行 `视频处理助手.bat`
2. 或直接运行：`python gui_app.py`

#### 图形界面功能
1. **视频时长调整标签页**：
   - 选择字幕文件 (.srt)
   - 选择分镜文件 (.txt)
   - 选择视频文件夹
   - 点击"开始处理视频"

2. **分镜描述词提取标签页**：
   - 选择输入文件 (.txt)
   - 选择保存目录（可选）
   - 选择要提取的内容
   - 点击"开始提取"

3. **处理日志标签页**：
   - 查看实时处理日志
   - 清空日志内容

### 方法二：使用批处理脚本

#### 视频时长调整
1. 双击运行 `视频匀速助手.bat`
2. 按照提示输入：
   - 字幕文件路径 (.srt)
   - 分镜文件路径 (.txt)
   - 视频文件夹路径

#### 分镜描述词提取
1. 双击运行 `分镜描述词助手.bat`
2. 按照提示输入文本文件路径
3. 选择保存目录（可选）

### 方法三：直接运行 Python 脚本

#### 视频时长调整
```bash
python main.py
```

#### 分镜描述词提取
```bash
python txt_split.py
```

#### 图形界面
```bash
python gui_app.py
```

## 开发说明

### 代码结构

#### `main.py` 主要函数
- `adjust_video_to_target_duration()`: 调整单个视频到目标时长
- `process_folder_videos()`: 批量处理文件夹中的视频
- `parse_time_to_seconds()`: 将时间字符串转换为秒数
- `get_duration_dict()`: 从字幕和分镜文件计算目标时长
- `main()`: 主程序入口

#### `txt_split.py` 主要函数
- `format_string()`: 格式化文本并提取内容
- `select_save_directory()`: 选择保存目录对话框
- `save_to_file()`: 保存内容到文件
- `read_file()`: 读取文件内容

#### `gui_app.py` 图形界面
- `VideoProcessorGUI`: 主界面类，管理所有GUI组件
- `create_widgets()`: 创建界面布局和控件
- `process_videos()`: 视频处理功能入口
- `process_split()`: 分镜提取功能入口
- `_process_videos_thread()`: 视频处理后台线程
- `_process_split_thread()`: 分镜提取后台线程
- 使用多线程处理，避免界面卡顿
- 实时日志显示处理进度

### 编码规范
- 使用 UTF-8 编码
- 函数和变量使用英文命名
- 添加中文注释说明关键逻辑
- 错误处理使用 try-except 结构

## 常见问题

### 1. 缺少 moviepy 库
**错误信息**：`ImportError: No module named 'moviepy'`
**解决方案**：
```bash
pip install moviepy==1.0.3
# 或
conda install -c conda-forge moviepy
```

### 2. 视频处理失败
**可能原因**：
- 视频文件损坏或格式不支持
- FFmpeg 未正确安装
- 文件路径包含中文字符或特殊字符

**解决方案**：
- 检查视频文件是否可以正常播放
- 确保使用英文路径和文件名
- 检查 FFmpeg 安装状态

### 3. 时间解析错误
**可能原因**：字幕文件格式不符合标准 SRT 格式
**解决方案**：确保字幕文件格式正确：
```
1
00:00:00,000 --> 00:00:01,500
字幕内容

2
00:00:01,500 --> 00:00:03,000
下一段字幕
```

## 版本历史

根据 Git 提交记录：
- `8eb3433` feat: 新增分镜描述词提取
- `b5e5efb` fix: 精确加速后帧率
- `51556cf` feat: 新增视频文案加速处理
- `a8d1077` fix: update bat name
- `74fac58` fix: fix index

## 注意事项

1. **备份原始文件**：处理视频前建议备份原始文件
2. **文件命名**：视频文件应按顺序命名（如 1.mp4, 2.mp4, ...）
3. **路径规范**：避免使用中文路径和特殊字符
4. **系统兼容性**：批处理脚本仅适用于 Windows 系统
5. **性能考虑**：视频处理较耗时，建议分批处理大量文件

## 扩展建议

如需扩展功能，可考虑：
1. 添加更多视频格式支持
2. 实现图形用户界面 (GUI)
3. 添加视频质量参数调整
4. 支持更多字幕格式
5. 添加批量重命名功能

---

*最后更新：2026-01-12*